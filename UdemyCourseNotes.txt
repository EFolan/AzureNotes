User defined routes - IP forwarding

Scenario: Desire forcing net traffic to travel a particular route from azure to your system before having access to the internet.

Azure portal > New > Everything > Route Table

Created route table default has no routes.

Go into routes. Add route.

Route name: name; Address prefix: 0.0.0.0/0 = all traffic

Next Hop type: Virtual network gateway functions as a site to site vpn, forcing all traffic to go via that route.

Route table now contains one route but isn't associated with a subnet.

Go to subnets and search/add the relevant subnet to apply the route table rules.

---

Firewalls are provided in the Azure marketplace.

Being set up is the same as a Route table in that you'd need to force all subnet traffic through the firewall in order for it to be effective.

--------------

Availability sets

Multiple VMs can be placed in an availability set (as long as they are similar or serve similar purposes.)

MS will allocate these VMs across their own servers/networks in order to help guarantee a high percentage of availability. 

A new availablity set can be created while standing up new VMs

VMs created: 

Avail-Set-1
User: EFolan
Pass: Chr0ma

Avail-Set-2
Same User and Pass

----------------

Use External and Internal load balancing

Fault domains:
The hardware upon which the VMs run. Different fault domains ensure that not all your VMs share the same hardware.

Update domains:
Updates will never hit all your VMs at once. MS will update one update domain at a time.


Load balancers:

Search load balancers > MS has one > Create.

Public: Traffic that comes in from the internet. Load balancer will distribute this traffic between VMs

Internal: Same but Between internal infrastructure

Probes check if sites are still up

Backend Pools > Create

Machines in Availability set can be added to pool

Back end pool now has all x VMs from the availability set.


Health probes:

Load balancer needs a way to see if VMs are alive. So we use the health probe.

Can be customised to web ports etc.

Will check web page every x seconds and after 2 failed checks determines that this VM has failed.


Load balancing rules: What are we going to do when traffic comes in.

Can specify port mapping shich forces traffic off of port 80 (for example) to port 8000 on the backend machines.

Session persistence: (AKA sticky sessions) None: any user can go to any VM at any time.


-------

Use Application gateway

Relatively new alternative to load balancer.

Only does web based load balancing : http or https

Has a firewall option.

Cookie based session affinity

Secure Sockets Layer SSL installed on the application gateway rather than on the web server giving the server the chance to just do its web server work and not worry about SSL.

              Internet
                  |
                  V
Azure Traffic manager(DNS load blncr)
_________________|______________
|                              |
V                              V
Azure                        Azure   
Load                          Load
balancer                    balancer
   _|_                         |
   VVV                         V
3x Application Gateway      1 App GW
    XXX                       |||
  VVVVVVV                     VVV
VM|VM|VM                    VM|VM|VM


------------------------------------

Scaling VM sizes

Desire: Scale VM up from A0 to A1 etc.

Virtual machine > Settings > Size > Size choice.

Can take some time to migrate VM.

---------------------------------

Virtual machine scale sets
            
Search VM Scale set

Allows me to allocate several VMs under a single name.

Must be created in a new resource.

REquires a public IP Address
Allows us to assign a domain name upon creation.

Choose OS image same as usual.

Allowed to choose between 1 and 200 instances

Choose machine size...

Autoscale:

When enabled  we can choose a minimum and maximum number of VMs. Can also set a CPU threshold in % for the set to start scaling up the amount of VMs

Also allows Scale down threshold to be set in %

Also: Legal disclaimer saying that VM scale sets can and will deploy multiple azure resources as needed.

This allows all the work of creating multiple VMs to be done rather quickly.

-------------------------------

ARM VM Storage

After creating a VM with a size that allows two disks it is possible to spin up and associate another disk. under Settings > Disks

Plan for storage capacity:

The A series allows local physical HDD of 20GB only.

They allow an additional data disk (Blob storage) to be spun up alongside.

There are limitations on the throughput of that data disk in the A series.

An S as part of the VM series name that means it includes an SSD
EG: DS1, DS2 etc

------

Geo replication options

When creating storage accounts there is a replication option

Lowest level of replication is Locally redundant storage.

3 copies of your files stored locally within the one data centre, spread across multiple locations. 
If one hard disk fails then yours can be rebuilt and restored from copies.

Zone redundant storage stores files within the Geo but in different physical locations.

The Geo could be USA or China etc

Geo redundant storage:
Stores six copies of your files around the world.

REad access Geo redundant storage:
Sets up Read accessible copies around the world.

-----

Premium or standard storage

Differences are a req of the exam

Premium storage is stored on SSDs: No magnetic disks or heads with very low latency.

More expensive than standard storage and only certain types of VM support premium (THe ones with S in the type name)

Premium ONLY supports Locally Redundant Storage

In a HDD environment there is a max of 500 operations per second.

In Premium limits are the expected value rather than peaks.

It's good to really go over these differences for the exam.


---------------------------------


Monitor Azure Virtual machines

It's possible to create alerts for when the % CPU usage breaches a certain threshold.

It can notify us via email or webhook.

Diagnostics:

Allows different types of diagnostics for .net, SQL, ASP etc etc etc.

Can choose one or several different kinds of diagnostics which will be created in a chosen storage account. 

All this can be found in the Monitoring section under VMs.

Good practice to read more up on this as we go along.

--------------------------------

Overview of availability sets

Objective 1.7: MAnaging ARM availability.

Can be managed through availability sets.

Inside Availability set there are a number of VMs.

The AS is configured to have x amount of fault domains and x amount of update domains.

Fault domains:
The separate hardware locations your VMs are running on. An AS with two Fault domains will be able to split it's VMs between two separate pieces of hardware, meaning if one fails the other will still be up and running.

Update domains:
Microsoft will never push updates to all update domains at a time. They will go one after the other meaning that if VMs are spread over Update domains they won't all be incapacitated by updates simultaneously.

Domains are zero indexed in the list in Azure portal.

MS has a service agreement of 99.95% uptime if you have two or more VMs running in an availability set.

----------------------------------------
End of Objective 1
----------------------------------------
----------------------------------------

Objective 2: Design and implement a storage and data strategy... 25 - 30% of final score.
----------------------------------------

Create a storage account

Generally you'll use standard (General storage) storage and use Blob storage when you need storage specifically calibrated for blobs.

There's an option for performance: Standard and Premium. We've covered this already. Standard is on HDDs and Premium is on SSDs.

There'll be an option to set the desired replication level. Again, we've covered this before. Typically we'll pick LRS; locally redundant storage. The other options are covered in detail further up.

Let's go over them anyway.

LRS:  Stores three copies of your data in separate physical locations but in the same data centre.

Zone redundant Storage:
Stores three separate copies of your data across different location 'zones' but within the same Geo location. So Data may be spread across the US or China.

Geo redundant Storage:
Six copies of the data are stored across the globe.

Read Accessible Geo redundant storage:
Same as above except you have read access to your file copies.


Encryption is also available.

If we need the data encrypted on the disk it is possible here.

Resource group and location are created as usual.

----------------------

Put a cdn in front of a storage account

CDN: Content Delivery network

Demonstrate adding a CDN to a storage account.

Create a public container with Blob access type which can be public.

Upload a file.

Search CDN: MS provide a CDN for various large file types that can be placed in various geographical locations around the world.

Create and place in the appropriate resource group.

Pricing tiers are varied and provided by various sources such as Verizon, Akamai etc.

After creation:

We have 0 endpoints so we're going to want to set one up.

An endpoint is the new url for your content.

Choose a unique name for the endpoint. 

Origin type: Storage

Origin path the path that directs to the CDN:

/publicfiles in the video.
This is the path to our public container

Leave origin host header.

It'll create an endpoint.

CDN gets pointed to container so container name not required.

----------

Add directories and subdirectories to Blob containers

Can be coded to create a directory structure as needed.

------------------

Use Custom domain names with storage accounts

Can we customise the domain name of a blob/container without a CDN? Yes.

Custom domain property of the Storage account.

Create a CNAME record with a DNS provider that points from your domain to the blob.core.windows.net address.

THis method is simple but requires brief downtime while Azure verifies the domain registration.

Alternately:

Create a CNAME record with your DNS provider that [pints from the asverify subdomain EG asverify.mydomain.com to the asverify subdom of the container url. After this completes you can create a CNAME tat points to the container url standard. 

This method won't incur any down time.

When using this method check the "use indirect CNAME validation" checkbox.

-----------------

Scale a blob container

There are limits of storage accounts in Azure

Max TB in a single storage account: 500 terabytes

One container/blob, table or queue can contain the 500TB. They have a max size of 500TB.

Max size of block blob is approx 195GB. Actual: 50,000 X 4MB

Max size of a page blob is 1TB

Also a limit on operations per second.
MS measures these in 8KB chunks called  8KB IOPS. 
The limit is 1000 8KB IOPS per share.

Sharding: With a storage account and a container, if you need to create 500 1TB files the only option is to create another storage account.

This will double your limits.

A problem to consider is how to divide the data between multiple storage accounts. Options exist such as indexing based on file alphabetical order or round robin etc.

--------------------------------------

Objective 2.2: Implement table and queue storage.

Table storage is a noSQL table structure.

You can create your own data structures and it is extremely fast.

Good option for fast flexible data.

----
Insert data into a table

Creating and adding to table storage in the code examples.

Partition Key: a key that defines the kind of entity that is being held in storage. 
For instance if a CarEntity is stored then the partition key should be "car". Similarly, a TruckEntity would have partition key: "truck".

RowKey: This is the primary key for the item in question. Should be unique in its table.

-----
Retrieve an Object from a Table

-----

Transactions

In SQL Server you can wrap a set of operations in a transaction and if one of them fails none of them will complete.

Within table storage Transactions are handled with TableBatchOperations.

Executed in a Batch: Either they all work or they all fail.

Some rules, drawbacks:

In order to work, every operation in a batch must be performed on objects with the same Partition key.

Limit of 100 operations that can be in a batch together.

Only one operation per row.

Create a TableBAtchoperation instance.
Insert all new objects into the batch.
Execute the batch operation.

------

Create your first Queue...
Queue creation in code snippet for table storage

Azure Storage naming conventions:

Storage account:
Length: 3 - 24
lowercase only
valid chars: alphanumeric

Blob names:
length: 1 - 1024
case-sensitive
valid chars: any url chars

Container name
length: 3 - 63
lowercase only
valid chars: alphanumeric and dash

Queue name
length: 3 - 63
lowercase only
valid chars: alphanumeric and dash

Table name:
length: 3-63
case-insensitive
valid chars: alphanumeric















